---
title: "결제/정산 도메인에서 배운것"
header:
  teaser: /assets/images/rapport_labs_logo.jpg
  overlay_image: /assets/images/rapport_labs_logo.jpg
  overlay_filter: 0.5
  caption: "RapportLabs [**라포랩스**]()"
tags:
  - Kotlin
  - Transaction
  - SQL
  - MSA
---


# 패션커머스에서 배운것
짧은 한달 동안 패션 커머스 회사에서 결제/정산 담당을 했었습니다.
여러가지를 배웠고 이를 남겨보고자 합니다.

## AI로 코딩, 업무자동화 
### Tool 
**Claude Code**

### Agent(행동 주체)
**Architect** Cluade.md를 root로 agent coding을 할수있도록 Rule을 만들어 Skill을 적절히 사용할 수 있도록 도와주는 Tool  
**Agentrules**상동

### MCP (에이전트의 인터페이스)
**Serena** 단어 단위로 쪼개 더 잘 이해할수 있도록 한다  
**Sequential Thinking** 스스로 단계적으로 생각해 더 나은 결과를 도출  
**Context7** 문맥이해 

프로젝트 단위로 rule, skill 등을 관리하여 클로드 코딩 시 규칙에 맞는 일정한 결과물이 나올 수 있도록 관리함. 실제로 클로드가 코딩하면 개발자가 이를 리뷰하고 고치면서 리뷰하는 방식

## AI 리뷰
깃허브와 연동하여 PR를 올려 댓글을 달면 AI가 리뷰를 도와줌(단, 전체 프로젝트 맥락을 이해한 AI인지, 단지 Diff만 보고 리뷰를 달아주는 것인지는 확인해야함)
  
## AI 업무 자동화
슬랙에 Bot, Workflow를 잘 활용하여 자동화를 잘해두었음. 모든 채널 슬랙 메시지를 읽어 Daily Brief로 다른 직원들에게도 공유해주는 것 생산성 높이고 좋았음. Company Wide View

## BigQuery 정산 대사
DB와 동일한 데이터를 모든 Schema, Table을 간편하게 모아둔 DE들이 사용하는 소스입니다. 이를 이용해 다양한 배치 작업을 만듭니다.

내부 원장과 외부 원장사이의 이격을 탐색하는 대사 쿼리를 작성하였습니다.
#### 재밌던 부분
- 데이터가 많아 쿼리는 1~3분 정도 걸립니다. 이 사이에 데이터가 변경된 경우 반영되지 않은 채로 대사가 돌아가 잘못된 결과를 낳습니다. 이에 이격이 발생한 데이터들에 대해 날짜상관없이 전체에 대해(where 절로 데이터를 한번 끊어내고) 다시한번 쿼리를 돌려 그때도 이격이 난 데이터들만 알림을 보냅니다.
- 엔티티들 간의 관계를 고려하여 어떤 기준으로 이격을 탐지할 것인지 중간에 다른 엔티티를 기준으로 한번 비교도 하는 등 WITH절, DATE_FILTER 등을 활용하여 복잡한 로직으로 늘려 더 정확한 이격탐색을 하도록 하였습니다.


## 트랜잭션
결제는 호흡이 굉장히 깁니다. 즉, 굉장히 복잡한 비즈니스 로직(내부 DB 변경), 3rd Party 호출을 한번의 호흡으로 전부 데이터 동일을 보장해야만 합니다. 그렇기에 재밌는 도메인 입니다.

데이터 변경하는 구간(동일 트랜잭션)들 끼리 트랜잭션을 묶어 경계를 잘 나누는 것이 중요합니다. 3rd Party에 의존하는 구간은 굉장히 장애가 많이 나는 구간이기 때문에 경계를 명확히 나누고 모든 Exception 경우에 대한 처리를 해놓아야합니다. 그렇지 않을 시 외부 원장과 내부 원장의 데이터 정합성 차이가 발생하여 정산 시 이격이 발생하여 문제가 됩니다.


#### 재밌던 부분 
- 예외에 상관없이 @Transactional(Propagation.REQUIRES_NEW) 등으로 데이터 기록하는 구간은 별도의 트랜잭션으로 무조건 기록이 되게끔 만듭니다.
- 예상치 못한 구간에서 예외가 많이 발생하여 롤백됩니다. 이런 예외 케이스를 발견하면 잡아서 밖으로 던져서 롤백이 되거나, 되지 않거나 개발자의 의도대로 흘러가게 해야합니다. I/O Exception은 주로 Checked Exception으로 롤백이 되지 않지만 의도적으로 RuntimeException으로 바꿔 던져 Rollback을 시키는 경우도 있습니다.
- 모든 구간을 불필요하게 메시지 큐에 던질 필요는 없습니다. 내부 데이터가 바뀌는 비즈니스 로직 구간을 비동기 메시지큐에서 동기로 바꾼 사례가 있습니다. 다만, 특정한 구간의 경우 메시지 큐에 이벤트를 발행하여 다른 MS가 알도록 합니다.

#### 왜 나는 결제/정산을 좋아했을까?
모든 예외 경우를 생각하고, 장애 발생 시 모니터링 툴(DataDog, Grafana), 저장소/인덱서(Loki), 로그 수집기(Opentelemetry Agent) 등을 이용하여 분산 트레이싱으로 장애를 추적합니다. 의심되는 구간을 trace_id, 문자열 검색 등을 이용하여 추적하는 과정이 즐거웠습니다.



## 배치작업
위에서 잡지 못한 데이터 정합성 부분을 보정하기 위한 배치가 굉장히 많이 돌아가고 있습니다. 분산 원장 사이의 차이를 탐지하는 배치, 데이터 정합성이 깨진 경우 이를 보정하는 배치(내부 데이터가 꺠진 경우 이용자에겐 결제 실패로 보였을테고, PG사엔 실제 결제가 일어났을 수도 있으니 뒷단에서 주로 결제를 취소시킵니다)

짧지만 일할 기회를 준 전 회사(스타트업)에 크게 감사합니다. 정말 즐거웠습니다.